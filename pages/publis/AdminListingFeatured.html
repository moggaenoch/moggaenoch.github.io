<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Featured Listings - Admin | JUBA HOMEZ</title>

  <!-- Bootstrap 5.3 (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body { font-family: Candara, "Segoe UI", Tahoma, Arial, sans-serif; }
    .app-shell{min-height:100vh;}
    .sidebar-link.active{font-weight:700;}
    .table td,.table th{vertical-align:middle;}
    .thumb { width: 54px; height: 40px; object-fit: cover; border-radius: .5rem; }

    /* Remove dropdown caret sign */
    .dropdown-toggle::after { display: none !important; }

    /* Featured preview row */
    .featured-scroll {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      padding-bottom: .25rem;
      scroll-snap-type: x mandatory;
    }
    .featured-card {
      min-width: 360px;
      max-width: 360px;
      scroll-snap-align: start;
    }
    .featured-card img {
      height: 190px;
      object-fit: cover;
    }
    .pill { font-size: .9rem; }
  </style>
</head>

<body class="bg-light">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom sticky-top">
    <div class="container-fluid">
      <button class="btn btn-outline-secondary d-lg-none me-2" data-bs-toggle="offcanvas" data-bs-target="#adminSidebar" aria-label="Open menu">‚ò∞</button>
      <a class="navbar-brand fw-bold" href="AdminDashboard.html">JUBA HOMEZ</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="AdminDashboard.html">ADMIN</a></li>
          <li class="nav-item"><a class="nav-link" href="Adminlisting.html">ALL LISTINGS</a></li>
          <li class="nav-item"><a class="nav-link" href="AdminListingPending.html">PENDING</a></li>
          <li class="nav-item"><a class="nav-link active fw-semibold" href="AdminListingFeatured.html">FEATURED</a></li>
        </ul>

        <div class="d-flex align-items-center gap-2">
          <a class="btn btn-primary d-none d-lg-inline-flex" href="Adminlisting.html">+ Add Listing</a>

          <a class="btn btn-outline-secondary position-relative" href="AdminMessages.html" title="Messages">üí¨
            <span id="messagesBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
          </a>
          <a class="btn btn-outline-secondary position-relative" href="AdminNotifications.html" title="Notifications">üîî
            <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
          </a>

          <form class="d-none d-lg-flex" role="search" action="#" method="get">
            <input class="form-control me-2" type="search" placeholder="Search featured..." name="q" />
            <button class="btn btn-primary" type="submit">Search</button>
          </form>

          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-label="Profile menu">üë§</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="AdminProfile.html">Profile</a></li>
              <li><a class="dropdown-item" href="AdminSetting.html">Settings</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="login.html">Sign out</a></li>
            </ul>
          </div>
        </div>

      </div>
    </div>
  </nav>

  <div class="container-fluid app-shell">
    <div class="row">

      <!-- SIDEBAR -->
      <aside class="offcanvas-lg offcanvas-start bg-white border-end col-lg-3 col-xl-2 p-0"
             tabindex="-1" id="adminSidebar">
        <div class="offcanvas-header border-bottom">
          <h5 class="offcanvas-title">Admin Menu</h5>
          <button class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#adminSidebar" aria-label="Close"></button>
        </div>

        <div class="offcanvas-body p-0">
          <div class="accordion accordion-flush" id="sidebarAccordion">

            <div class="accordion-item"><h2 class="accordion-header">
              <a class="accordion-button collapsed px-3 py-3 text-decoration-none sidebar-link" href="AdminDashboard.html">Overview</a>
            </h2></div>

            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button px-3 py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseListings" aria-expanded="true">
                  Listings
                  <span class="ms-auto d-flex gap-2">
                    <span class="badge bg-warning-subtle text-warning" id="badgePending">0</span>
                    <span class="badge bg-success-subtle text-success" id="badgeActive">0</span>
                  </span>
                </button>
              </h2>

              <div id="collapseListings" class="accordion-collapse collapse show" data-bs-parent="#sidebarAccordion">
                <div class="accordion-body px-0 py-0">
                  <div class="list-group list-group-flush">
                    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center sidebar-link"
                       href="AdminListingPending.html">
                      Pending Approval <span class="badge text-bg-warning rounded-pill" id="countPending">0</span>
                    </a>
                    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center sidebar-link"
                       href="Adminlisting.html">
                      All Listings <span class="badge text-bg-secondary rounded-pill" id="countAll">0</span>
                    </a>
                    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center sidebar-link active"
                       href="AdminListingFeatured.html">
                      Featured <span class="badge text-bg-primary rounded-pill" id="countFeatured">0</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <div class="accordion-item"><h2 class="accordion-header">
              <a class="accordion-button collapsed px-3 py-3 text-decoration-none sidebar-link" href="AdminContent.html">Content & Marketing</a>
            </h2></div>

            <div class="accordion-item"><h2 class="accordion-header">
              <a class="accordion-button collapsed px-3 py-3 text-decoration-none sidebar-link" href="admin-users.html">Users & Roles</a>
            </h2></div>

            <div class="accordion-item"><h2 class="accordion-header">
              <a class="accordion-button collapsed px-3 py-3 text-decoration-none sidebar-link" href="admin-verification.html">Verification</a>
            </h2></div>

            <div class="accordion-item"><h2 class="accordion-header">
              <a class="accordion-button collapsed px-3 py-3 text-decoration-none sidebar-link" href="AdminLeads.html">Leads</a>
            </h2></div>

            <div class="accordion-item"><h2 class="accordion-header">
              <a class="accordion-button collapsed px-3 py-3 text-decoration-none sidebar-link" href="admin-payments.html">Payments</a>
            </h2></div>

            <div class="accordion-item"><h2 class="accordion-header">
              <a class="accordion-button collapsed px-3 py-3 text-decoration-none sidebar-link" href="admin-moderation.html">Moderation</a>
            </h2></div>

            <div class="accordion-item"><h2 class="accordion-header">
              <a class="accordion-button collapsed px-3 py-3 text-decoration-none sidebar-link" href="AdminAnalytic.html">Analytics</a>
            </h2></div>

            <div class="accordion-item"><h2 class="accordion-header">
              <a class="accordion-button collapsed px-3 py-3 text-decoration-none sidebar-link" href="AdminDashboard.html#system">System</a>
            </h2></div>

          </div>

          <div class="p-3 border-top small text-muted">&copy; 2026 JUBA HOMEZ</div>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="col-lg-9 col-xl-10 px-0">
        <div class="p-3 p-md-4">

          <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-3">
            <div>
              <h1 class="h3 mb-1">Featured Listings</h1>
              <p class="text-muted mb-0">Manage what shows in the home page ‚ÄúFeatured / Hottest Properties‚Äù section.</p>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <a class="btn btn-outline-secondary" href="Adminlisting.html">Go to All Listings</a>
              <button class="btn btn-outline-secondary" id="btnResetOrder" type="button">Reset Order</button>
              <button class="btn btn-primary" id="btnSeedDemo" type="button">Load Demo Featured</button>
            </div>
          </div>

          <!-- SETTINGS + STATS -->
          <div class="row g-3 mb-3">
            <div class="col-12 col-xl-5">
              <div class="card shadow-sm">
                <div class="card-header bg-white fw-semibold">Featured Settings</div>
                <div class="card-body">
                  <div class="row g-2">
                    <div class="col-12 col-md-6">
                      <label class="form-label">Featured duration (days)</label>
                      <input class="form-control" id="featDays" type="number" min="1" value="7">
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label">Featured price ($)</label>
                      <input class="form-control" id="featPrice" type="number" min="0" value="50">
                    </div>
                  </div>
                  <div class="d-grid mt-3">
                    <button class="btn btn-primary" id="btnSaveSettings" type="button">Save Settings</button>
                  </div>
                  <div class="mt-3 text-muted small">Connect to: <code>PATCH /api/admin/settings</code></div>
                </div>
              </div>
            </div>

            <div class="col-12 col-xl-7">
              <div class="card shadow-sm">
                <div class="card-header bg-white fw-semibold">Featured Summary</div>
                <div class="card-body">
                  <div class="d-flex flex-wrap gap-2">
                    <span class="badge text-bg-primary pill">Featured: <span id="statFeatured">0</span></span>
                    <span class="badge text-bg-secondary pill">All Listings: <span id="statAll">0</span></span>
                    <span class="badge text-bg-success pill">Active: <span id="statActive">0</span></span>
                    <span class="badge text-bg-warning pill">Pending: <span id="statPending">0</span></span>
                  </div>
                  <div class="mt-3 alert alert-info mb-0">
                    Tip: Use <strong>Up/Down</strong> to control the order shown on the home page carousel.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- PREVIEW -->
          <div class="card shadow-sm mb-3">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <div class="fw-semibold">Home Page Preview</div>
              <span class="text-muted small">Scroll sideways</span>
            </div>
            <div class="card-body">
              <div id="featuredPreview" class="featured-scroll"></div>
              <div id="noFeaturedPreview" class="text-muted small d-none">No featured listings yet. Feature some listings first.</div>
            </div>
          </div>

          <!-- TABLE -->
          <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <div class="fw-semibold">Featured Listings Manager</div>
              <span class="text-muted small">Connect to: <code>GET /api/admin/listings?featured=true</code></span>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width:92px;">Order</th>
                    <th>Listing</th>
                    <th>Owner/Broker</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th>Expires</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody id="featuredTbody"></tbody>
              </table>
            </div>

            <div class="card-footer bg-white d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
              <span class="small text-muted">Saved locally for demo: <code>localStorage</code> (swap to backend later).</span>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="btnExportJson" type="button">Export JSON</button>
                <button class="btn btn-outline-secondary btn-sm" id="btnImportJson" type="button">Import JSON</button>
              </div>
            </div>
          </div>

        </div>

        <footer class="border-top">
          <div class="container py-4 d-flex flex-column flex-md-row gap-2 align-items-center justify-content-between">
            <p class="mb-0 text-muted">&copy; 2026 JUBA HOMEZ. All rights reserved.</p>
            <div class="d-flex gap-3">
              <a class="text-decoration-none text-muted" href="../public/Contact.html">Contact</a>
              <a class="text-decoration-none text-muted" href="../public/Property_Rent.html">Rentals</a>
              <a class="text-decoration-none text-muted" href="../public/Property_Sale.html">Sales</a>
            </div>
          </div>
        </footer>

      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ======= TOP BADGES (demo) =======
    const demoTop = { notifications: 3, messages: 1 };
    function setBadge(id, count){
      const el=document.getElementById(id); if(!el) return;
      el.textContent=count;
      el.classList.toggle("d-none", !count || count <= 0);
    }
    setBadge("notifBadge", demoTop.notifications);
    setBadge("messagesBadge", demoTop.messages);

    // ======= STORAGE =======
    const LISTINGS_KEY = "jh_admin_listings_v1";
    const SETTINGS_KEY = "jh_featured_settings_v1";

    function loadJSON(key, fallback){
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch(e){
        return fallback;
      }
    }
    function saveJSON(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    function getSettings(){
      const s = loadJSON(SETTINGS_KEY, { durationDays: 7, price: 50 });
      return {
        durationDays: Math.max(1, Number(s.durationDays || 7)),
        price: Math.max(0, Number(s.price || 50))
      };
    }
    function setSettings(next){
      saveJSON(SETTINGS_KEY, next);
    }

    function seedListings(){
      // Demo data (replace with backend later)
      const now = new Date().toISOString().slice(0,10);
      const demo = [
        { id: 701, title: "Modern Apartment", location: "Munuki", type: "House", owner: "Broker A", price: "$1,200 / month", status: "Active",
          featured: true, featuredAt: new Date().toISOString(), featuredOrder: 1, thumb: "https://picsum.photos/seed/jubahomez1/720/480" },

        { id: 702, title: "Family House", location: "Gudele", type: "House", owner: "Owner B", price: "$45,000", status: "Active",
          featured: true, featuredAt: new Date().toISOString(), featuredOrder: 2, thumb: "https://picsum.photos/seed/jubahomez2/720/480" },

        { id: 703, title: "Studio Near Town", location: "Kator", type: "Apartment", owner: "Broker C", price: "$650 / month", status: "Pending",
          featured: false, thumb: "https://picsum.photos/seed/jubahomez3/720/480" },

        { id: 704, title: "Land Plot", location: "Jebel", type: "Land", owner: "Owner D", price: "$18,000", status: "Active",
          featured: true, featuredAt: new Date().toISOString(), featuredOrder: 3, thumb: "https://picsum.photos/seed/jubahomez4/720/480" },

        { id: 705, title: "Commercial Space", location: "Nyakuron", type: "Commercial", owner: "Broker E", price: "$2,500 / month", status: "Active",
          featured: false, thumb: "https://picsum.photos/seed/jubahomez5/720/480" }
      ];
      saveJSON(LISTINGS_KEY, demo);
      return demo;
    }

    function getListings(){
      const list = loadJSON(LISTINGS_KEY, null);
      if(!Array.isArray(list) || list.length === 0) return seedListings();
      return list;
    }
    function setListings(list){
      saveJSON(LISTINGS_KEY, list);
    }

    // ======= FEATURED HELPERS =======
    function normalizeFeaturedOrder(list){
      const featured = list.filter(x => x.featured).sort((a,b)=>(a.featuredOrder||9999)-(b.featuredOrder||9999));
      featured.forEach((x, idx) => x.featuredOrder = idx + 1);
      return list;
    }

    function computeExpiry(listing, settings){
      if(!listing.featured || !listing.featuredAt) return "‚Äî";
      const start = new Date(listing.featuredAt);
      if(isNaN(start.getTime())) return "‚Äî";
      const end = new Date(start);
      end.setDate(end.getDate() + settings.durationDays);
      const y = end.getFullYear();
      const m = String(end.getMonth()+1).padStart(2,"0");
      const d = String(end.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }

    function badgeForStatus(status){
      const s = String(status||"").toLowerCase();
      if(s === "active") return `<span class="badge text-bg-success">Active</span>`;
      if(s === "pending") return `<span class="badge text-bg-warning">Pending</span>`;
      if(s === "hidden") return `<span class="badge text-bg-secondary">Hidden</span>`;
      if(s === "rejected") return `<span class="badge text-bg-danger">Rejected</span>`;
      return `<span class="badge text-bg-light text-dark">‚Äî</span>`;
    }

    // ======= RENDER =======
    function render(){
      const settings = getSettings();
      document.getElementById("featDays").value = settings.durationDays;
      document.getElementById("featPrice").value = settings.price;

      let listings = getListings();
      listings = normalizeFeaturedOrder(listings);
      setListings(listings);

      const all = listings.length;
      const active = listings.filter(x => String(x.status).toLowerCase()==="active").length;
      const pending = listings.filter(x => String(x.status).toLowerCase()==="pending").length;
      const featured = listings.filter(x => x.featured).sort((a,b)=>(a.featuredOrder||9999)-(b.featuredOrder||9999));

      // Sidebar counters + header badges
      const safeSet = (id, val) => { const el=document.getElementById(id); if(el) el.textContent = val; };
      safeSet("countAll", all);
      safeSet("countPending", pending);
      safeSet("countFeatured", featured.length);
      safeSet("badgePending", pending);
      safeSet("badgeActive", active);

      // Summary stats
      safeSet("statAll", all);
      safeSet("statActive", active);
      safeSet("statPending", pending);
      safeSet("statFeatured", featured.length);

      // Preview
      const preview = document.getElementById("featuredPreview");
      const emptyPreview = document.getElementById("noFeaturedPreview");
      preview.innerHTML = "";
      if(featured.length === 0){
        emptyPreview.classList.remove("d-none");
      } else {
        emptyPreview.classList.add("d-none");
        featured.forEach(item => {
          const card = document.createElement("div");
          card.className = "card shadow-sm featured-card";
          card.innerHTML = `
            <img src="${item.thumb || "https://picsum.photos/seed/jh/720/480"}" class="card-img-top" alt="thumb">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <div>
                  <div class="fw-semibold">${escapeHTML(item.title || "Untitled")}</div>
                  <div class="text-muted small">${escapeHTML(item.location || "‚Äî")} ‚Ä¢ #${item.id ?? "‚Äî"}</div>
                </div>
                <span class="badge text-bg-primary">#${item.featuredOrder || "‚Äî"}</span>
              </div>
              <div class="mt-2 d-flex justify-content-between align-items-center">
                <div class="text-muted small">${escapeHTML(item.price || "‚Äî")}</div>
                <a class="btn btn-sm btn-outline-secondary" href="admin-listing-detail.html?id=${encodeURIComponent(item.id ?? "")}">View</a>
              </div>
            </div>
          `;
          preview.appendChild(card);
        });
      }

      // Table
      const tbody = document.getElementById("featuredTbody");
      tbody.innerHTML = "";

      if(featured.length === 0){
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              No featured listings yet. Go to <a href="Adminlisting.html">All Listings</a> and feature some properties.
            </td>
          </tr>
        `;
        return;
      }

      featured.forEach(item => {
        const expiry = computeExpiry(item, settings);
        const canMoveUp = (item.featuredOrder || 9999) > 1;
        const canMoveDown = (item.featuredOrder || 9999) < featured.length;

        const warn = String(item.status||"").toLowerCase() !== "active"
          ? `<div class="small text-danger mt-1">‚ö† Not Active (won‚Äôt show on public site)</div>`
          : ``;

        const tr = document.createElement("tr");
        tr.dataset.id = item.id;

        tr.innerHTML = `
          <td>
            <div class="d-flex align-items-center gap-2">
              <input class="form-control form-control-sm" style="width:70px" type="number" min="1" value="${item.featuredOrder || 1}" data-action="setOrder">
            </div>
          </td>

          <td>
            <div class="d-flex gap-2 align-items-center">
              <img class="thumb" src="${item.thumb || "https://picsum.photos/seed/jh/120/80"}" alt="thumb">
              <div>
                <a class="text-decoration-none fw-semibold" href="admin-listing-detail.html?id=${encodeURIComponent(item.id ?? "")}">
                  ${escapeHTML(item.title || "Untitled")}
                </a>
                <div class="small text-muted">${escapeHTML(item.location || "‚Äî")} ‚Ä¢ #${item.id ?? "‚Äî"}</div>
                ${warn}
              </div>
            </div>
          </td>

          <td>${escapeHTML(item.owner || "‚Äî")}</td>
          <td>${escapeHTML(item.price || "‚Äî")}</td>
          <td>${badgeForStatus(item.status)}</td>
          <td><span class="text-muted">${expiry}</span></td>

          <td class="text-end">
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-secondary" type="button" data-action="up" ${canMoveUp ? "" : "disabled"}>‚Üë</button>
              <button class="btn btn-outline-secondary" type="button" data-action="down" ${canMoveDown ? "" : "disabled"}>‚Üì</button>
              <a class="btn btn-outline-secondary" href="admin-listing-detail.html?id=${encodeURIComponent(item.id ?? "")}">View</a>
              <button class="btn btn-outline-danger" type="button" data-action="unfeature">Remove</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ======= EVENTS =======
    document.getElementById("btnSaveSettings").addEventListener("click", () => {
      const days = Number(document.getElementById("featDays").value || 7);
      const price = Number(document.getElementById("featPrice").value || 50);
      setSettings({ durationDays: Math.max(1, days), price: Math.max(0, price) });
      render();
    });

    document.getElementById("btnSeedDemo").addEventListener("click", () => {
      seedListings();
      render();
    });

    document.getElementById("btnResetOrder").addEventListener("click", () => {
      const listings = normalizeFeaturedOrder(getListings());
      setListings(listings);
      render();
    });

    document.getElementById("btnExportJson").addEventListener("click", async () => {
      const blob = new Blob([JSON.stringify(getListings(), null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "jh_featured_listings_export.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById("btnImportJson").addEventListener("click", async () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.onchange = () => {
        const file = input.files && input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(String(reader.result || "[]"));
            if(!Array.isArray(data)) throw new Error("JSON must be an array.");
            setListings(data);
            render();
          } catch (e) {
            alert("Import failed: " + (e.message || e));
          }
        };
        reader.readAsText(file);
      };
      input.click();
    });

    document.getElementById("featuredTbody").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      if(!btn) return;

      const action = btn.getAttribute("data-action");
      const tr = btn.closest("tr");
      if(!tr) return;
      const id = Number(tr.dataset.id);

      let listings = getListings();
      listings = normalizeFeaturedOrder(listings);

      const featured = listings.filter(x => x.featured).sort((a,b)=>(a.featuredOrder||9999)-(b.featuredOrder||9999));
      const current = listings.find(x => Number(x.id) === id);
      if(!current) return;

      if(action === "unfeature"){
        current.featured = false;
        delete current.featuredOrder;
        delete current.featuredAt;
        setListings(normalizeFeaturedOrder(listings));
        render();
        return;
      }

      if(action === "up" || action === "down"){
        const dir = action === "up" ? -1 : 1;
        const idx = featured.findIndex(x => Number(x.id) === id);
        const swapWith = featured[idx + dir];
        if(!swapWith) return;

        const a = current.featuredOrder || (idx+1);
        const b = swapWith.featuredOrder || (idx+1+dir);
        current.featuredOrder = b;
        swapWith.featuredOrder = a;

        setListings(normalizeFeaturedOrder(listings));
        render();
        return;
      }
    });

    document.getElementById("featuredTbody").addEventListener("change", (e) => {
      const input = e.target.closest('input[data-action="setOrder"]');
      if(!input) return;

      const tr = input.closest("tr");
      const id = Number(tr.dataset.id);
      const desired = Math.max(1, Number(input.value || 1));

      let listings = getListings();
      listings = normalizeFeaturedOrder(listings);

      const featured = listings.filter(x => x.featured).sort((a,b)=>(a.featuredOrder||9999)-(b.featuredOrder||9999));
      const current = listings.find(x => Number(x.id) === id);
      if(!current) return;

      // Clamp to range
      const max = featured.length;
      const nextOrder = Math.min(max, desired);

      // Reorder by removing + inserting
      const without = featured.filter(x => Number(x.id) !== id);
      current.featuredOrder = nextOrder;

      // Insert at (nextOrder-1)
      without.splice(nextOrder - 1, 0, current);
      without.forEach((x, i) => x.featuredOrder = i + 1);

      // Apply back to listings
      const map = new Map(without.map(x => [Number(x.id), x.featuredOrder]));
      listings.forEach(x => { if(x.featured) x.featuredOrder = map.get(Number(x.id)); });

      setListings(normalizeFeaturedOrder(listings));
      render();
    });

    function escapeHTML(str){
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // Highlight active sidebar link
    (function highlightActiveLink(){
      const current=(location.pathname.split("/").pop()||"admin-listings-featured.html").toLowerCase();
      document.querySelectorAll(".sidebar-link").forEach(a=>{
        const href=(a.getAttribute("href")||"").toLowerCase();
        if(href===current) a.classList.add("active");
      });
    })();

    // Initial render
    render();
  </script>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/http.js"></script>
  <script src="assets/js/admin.js"></script>
  <script>Admin.wireComingSoon(); Admin.loadBadges(); Admin.loadPendingCounts();</script>

  <script src="assets/js/admin-listings.js"></script>
</body>
</html>
