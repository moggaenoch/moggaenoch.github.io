<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leads - Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body{ font-family: Candara, "Segoe UI", Tahoma, Arial, sans-serif; }
    .app-shell{min-height:100vh;}
    .sidebar-link.active{font-weight:700;}
    .table td,.table th{vertical-align:middle;}
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .dropdown-toggle::after{ display:none !important; } /* remove dropdown arrow */
  </style>
</head>

<body class="bg-light">
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom sticky-top">
    <div class="container-fluid">
      <button class="btn btn-outline-secondary d-lg-none me-2" data-bs-toggle="offcanvas" data-bs-target="#adminSidebar" aria-label="Open menu">â˜°</button>
      <a class="navbar-brand fw-bold" href="AdminDashboard.html">JUBA HOMEZ</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="AdminDashboard.html">ADMIN</a></li>
          <li class="nav-item"><a class="nav-link active fw-semibold" href="AdminLeads.html">LEADS</a></li>
        </ul>

        <div class="d-flex gap-2 align-items-center">
          <!-- If you don't have these pages yet, keep # and show coming soon -->
          <a class="btn btn-outline-secondary position-relative" href="#" data-coming-soon="Messages">ðŸ’¬
            <span id="messagesBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
          </a>
          <a class="btn btn-outline-secondary position-relative" href="#" data-coming-soon="Notifications">ðŸ””
            <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
          </a>

          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">ðŸ‘¤</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" data-coming-soon="Profile">Profile</a></li>
              <li><a class="dropdown-item" href="#" data-coming-soon="Settings">Settings</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="login.html">Sign out</a></li>
            </ul>
          </div>
        </div>

      </div>
    </div>
  </nav>

  <div class="container-fluid app-shell">
    <div class="row">

      <!-- SIDEBAR -->
      <aside class="offcanvas-lg offcanvas-start bg-white border-end col-lg-3 col-xl-2 p-0" tabindex="-1" id="adminSidebar">
        <div class="offcanvas-header border-bottom">
          <h5 class="offcanvas-title">Admin Menu</h5>
          <button class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#adminSidebar" aria-label="Close"></button>
        </div>

        <div class="offcanvas-body p-0">
          <div class="list-group list-group-flush">
            <a class="list-group-item list-group-item-action sidebar-link" href="AdminDashboard.html">Overview</a>
            <a class="list-group-item list-group-item-action sidebar-link" href="Adminlisting.html">Listings</a>
            <a class="list-group-item list-group-item-action sidebar-link" href="AdminLeads.html">Leads</a>
            <a class="list-group-item list-group-item-action sidebar-link" href="AdminDashboard.html#system">System</a>
          </div>
          <div class="p-3 border-top small text-muted">&copy; 2026 JUBA HOMEZ</div>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="col-lg-9 col-xl-10 px-0">
        <div class="p-3 p-md-4">

          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <div>
              <h1 class="h3 mb-1">Leads</h1>
              <p class="text-muted mb-0">Inquiries, booking requests, and contact submissions.</p>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button id="seedBtn" class="btn btn-outline-secondary" type="button">Seed Demo</button>
              <button id="exportBtn" class="btn btn-outline-secondary" type="button">Export CSV</button>
              <button id="refreshBtn" class="btn btn-primary" type="button">Refresh</button>
            </div>
          </div>

          <!-- KPIs -->
          <div class="row g-3 mb-3">
            <div class="col-6 col-lg-3">
              <div class="card shadow-sm"><div class="card-body">
                <div class="text-muted small">New</div>
                <div class="h4 mb-0" id="kpiNew">0</div>
              </div></div>
            </div>
            <div class="col-6 col-lg-3">
              <div class="card shadow-sm"><div class="card-body">
                <div class="text-muted small">Contacted</div>
                <div class="h4 mb-0" id="kpiContacted">0</div>
              </div></div>
            </div>
            <div class="col-6 col-lg-3">
              <div class="card shadow-sm"><div class="card-body">
                <div class="text-muted small">Closed</div>
                <div class="h4 mb-0" id="kpiClosed">0</div>
              </div></div>
            </div>
            <div class="col-6 col-lg-3">
              <div class="card shadow-sm"><div class="card-body">
                <div class="text-muted small">Total</div>
                <div class="h4 mb-0" id="kpiTotal">0</div>
              </div></div>
            </div>
          </div>

          <!-- FILTERS -->
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <form class="row g-2" id="filterForm">
                <div class="col-12 col-md-3">
                  <label class="form-label small text-muted">Status</label>
                  <select class="form-select" id="statusFilter">
                    <option value="">All</option>
                    <option value="New">New</option>
                    <option value="Contacted">Contacted</option>
                    <option value="Closed">Closed</option>
                  </select>
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label small text-muted">Date</label>
                  <input class="form-control" type="date" id="dateFilter" />
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label small text-muted">Search</label>
                  <input class="form-control" type="text" id="searchFilter" placeholder="Name, phone, email, listing id..." />
                </div>
                <div class="col-12 col-md-2 d-flex align-items-end gap-2">
                  <button class="btn btn-primary w-100" type="submit">Apply</button>
                  <button class="btn btn-outline-secondary w-100" type="button" id="resetBtn">Reset</button>
                </div>
              </form>
            </div>
          </div>

          <!-- TABLE -->
          <div class="card shadow-sm">
            <div class="card-header bg-white fw-semibold d-flex justify-content-between align-items-center flex-wrap gap-2">
              <span>Lead list</span>
              <span class="small text-muted">Connect to: <code>GET /api/admin/leads</code></span>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Lead</th>
                    <th>Listing</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th class="text-end">Action</th>
                  </tr>
                </thead>
                <tbody id="leadsTbody">
                  <!-- rendered by JS -->
                </tbody>
              </table>
            </div>

            <div class="card-footer bg-white small text-muted d-flex justify-content-between flex-wrap gap-2">
              <span id="rowsInfo">0 leads</span>
              <button class="btn btn-sm btn-outline-danger" id="clearBtn" type="button">Clear Demo Data</button>
            </div>
          </div>

          <!-- FOOTER (inside main, correct layout) -->
          <footer class="border-top mt-4">
            <div class="py-4 d-flex flex-column flex-md-row gap-2 align-items-center justify-content-between">
              <p class="mb-0 text-muted">&copy; 2026 JUBA HOMEZ. All rights reserved.</p>
              <div class="d-flex gap-3">
                <a class="text-decoration-none text-muted" href="../public/Contact.html">Contact</a>
                <a class="text-decoration-none text-muted" href="../public/Property_Rent.html">Rentals</a>
                <a class="text-decoration-none text-muted" href="../public/Property_Sale.html">Sales</a>
              </div>
            </div>
          </footer>

        </div>
      </main>
    </div>
  </div>

  <!-- VIEW MODAL -->
  <div class="modal fade" id="leadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Lead Details</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="modalLeadId" />
          <div class="row g-3">
            <div class="col-md-6">
              <div class="fw-semibold">Customer</div>
              <div id="mName"></div>
              <div class="text-muted small" id="mPhone"></div>
              <div class="text-muted small" id="mEmail"></div>
            </div>
            <div class="col-md-6">
              <div class="fw-semibold">Lead Info</div>
              <div class="text-muted small">Status: <span id="mStatus" class="fw-semibold"></span></div>
              <div class="text-muted small">Date: <span id="mDate" class="mono"></span></div>
              <div class="text-muted small">Source: <span id="mSource"></span></div>
              <div class="text-muted small">Listing: <a id="mListingLink" class="text-decoration-none" href="#">â€”</a></div>
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold">Message</label>
              <div class="border rounded-3 p-3 bg-light" id="mMessage">â€”</div>
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold">Internal Notes</label>
              <textarea id="mNotes" class="form-control" rows="3" placeholder="Add notes (only admin can see)â€¦"></textarea>
              <div class="form-text">Saved in demo localStorage.</div>
            </div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between flex-wrap gap-2">
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" id="markContactedBtn" type="button">Mark Contacted</button>
            <button class="btn btn-outline-success" id="closeLeadBtn" type="button">Close Lead</button>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">Close</button>
            <button class="btn btn-primary" id="saveNotesBtn" type="button">Save Notes</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="appToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Saved</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Demo badges
    const demo = { notifications: 3, messages: 1 };
    function setBadge(id, count){
      const el=document.getElementById(id);
      if(!el) return;
      el.textContent=count;
      el.classList.toggle("d-none", !count || count<=0);
    }
    setBadge("notifBadge", demo.notifications);
    setBadge("messagesBadge", demo.messages);

    // Prevent missing pages
    document.addEventListener("click", (e) => {
      const a = e.target.closest("[data-coming-soon]");
      if(!a) return;
      e.preventDefault();
      toast(a.getAttribute("data-coming-soon") + " (coming soon)");
    });

    // Active sidebar highlight
    (function(){
      const current=(location.pathname.split("/").pop()||"admin-leads.html").toLowerCase();
      document.querySelectorAll(".sidebar-link").forEach(a=>{
        const href=(a.getAttribute("href")||"").toLowerCase();
        if(href===current) a.classList.add("active");
      });
    })();

    // LocalStorage
    const LS_LEADS = "jh_admin_leads_v1";

    function uid(){ return "lead_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }

    function loadLeads(){
      try{
        const raw = localStorage.getItem(LS_LEADS);
        if(!raw) return [];
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : [];
      }catch(e){ return []; }
    }

    function saveLeads(list){
      localStorage.setItem(LS_LEADS, JSON.stringify(list));
    }

    function seedDemo(){
      const now = new Date();
      const d = (daysAgo) => {
        const x = new Date(now);
        x.setDate(x.getDate() - daysAgo);
        return x.toISOString().slice(0,10);
      };

      const sample = [
        {
          id: uid(),
          name: "Peter Customer",
          phone: "+211 9xx xxx xxx",
          email: "peter@example.com",
          listingId: 701,
          status: "New",
          date: d(5),
          source: "Contact form",
          message: "Hello, I want to view this property. Is it still available?",
          notes: ""
        },
        {
          id: uid(),
          name: "Mary Buyer",
          phone: "+211 9xx xxx xxx",
          email: "mary@example.com",
          listingId: 522,
          status: "Contacted",
          date: d(2),
          source: "Booking request",
          message: "Can I book a viewing this weekend? Please advise.",
          notes: "Asked to confirm Saturday 10am."
        },
        {
          id: uid(),
          name: "John Renter",
          phone: "+211 9xx xxx xxx",
          email: "john@example.com",
          listingId: 310,
          status: "Closed",
          date: d(12),
          source: "WhatsApp inquiry",
          message: "Looking for 2 bedroom in Munuki. Any options?",
          notes: "Converted to listing #315."
        }
      ];

      saveLeads(sample);
      toast("Demo leads added");
      render();
    }

    // UI refs
    const tbody = document.getElementById("leadsTbody");
    const rowsInfo = document.getElementById("rowsInfo");

    const kpiNew = document.getElementById("kpiNew");
    const kpiContacted = document.getElementById("kpiContacted");
    const kpiClosed = document.getElementById("kpiClosed");
    const kpiTotal = document.getElementById("kpiTotal");

    const statusFilter = document.getElementById("statusFilter");
    const dateFilter = document.getElementById("dateFilter");
    const searchFilter = document.getElementById("searchFilter");

    // Toast
    const toastEl = document.getElementById("appToast");
    const toastMsg = document.getElementById("toastMsg");
    const toastObj = new bootstrap.Toast(toastEl, { delay: 2200 });
    function toast(msg){
      toastMsg.textContent = msg;
      toastObj.show();
    }

    function badgeFor(status){
      if(status === "New") return `<span class="badge text-bg-warning">New</span>`;
      if(status === "Contacted") return `<span class="badge text-bg-primary">Contacted</span>`;
      if(status === "Closed") return `<span class="badge text-bg-success">Closed</span>`;
      return `<span class="badge text-bg-secondary">${status}</span>`;
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;");
    }

    function applyFilters(list){
      const st = statusFilter.value;
      const dt = dateFilter.value;
      const q = (searchFilter.value || "").trim().toLowerCase();

      return list.filter(l => {
        if(st && l.status !== st) return false;
        if(dt && l.date !== dt) return false;

        if(q){
          const hay = [
            l.name, l.phone, l.email,
            String(l.listingId ?? ""),
            l.source, l.message
          ].join(" ").toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }

    function updateKPIs(list){
      const nNew = list.filter(x => x.status==="New").length;
      const nCon = list.filter(x => x.status==="Contacted").length;
      const nCls = list.filter(x => x.status==="Closed").length;

      kpiNew.textContent = nNew;
      kpiContacted.textContent = nCon;
      kpiClosed.textContent = nCls;
      kpiTotal.textContent = list.length;
    }

    function render(){
      const all = loadLeads();
      updateKPIs(all);

      const filtered = applyFilters(all);
      rowsInfo.textContent = `${filtered.length} lead(s)`;

      tbody.innerHTML = "";
      if(filtered.length === 0){
        tbody.innerHTML = `<tr>
          <td colspan="5" class="text-center text-muted py-4">No leads found. Click <strong>Seed Demo</strong> to add sample leads.</td>
        </tr>`;
        return;
      }

      filtered.forEach(l => {
        const row = `
          <tr data-id="${esc(l.id)}">
            <td>
              <div class="fw-semibold">${esc(l.name)}</div>
              <div class="small text-muted">${esc(l.phone)} â€¢ ${esc(l.email)}</div>
            </td>
            <td><a class="text-decoration-none" href="admin-listing-detail.html?id=${encodeURIComponent(l.listingId)}">Listing #${esc(l.listingId)}</a></td>
            <td>${badgeFor(l.status)}</td>
            <td class="text-muted mono">${esc(l.date)}</td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" type="button" data-action="view">View</button>
                <button class="btn btn-outline-primary" type="button" data-action="contacted">Mark Contacted</button>
                <button class="btn btn-outline-success" type="button" data-action="close">Close</button>
              </div>
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    // Table actions
    tbody.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;

      const tr = e.target.closest("tr[data-id]");
      if(!tr) return;

      const id = tr.getAttribute("data-id");
      const action = btn.getAttribute("data-action");

      if(action === "view") return openModal(id);
      if(action === "contacted") return setStatus(id, "Contacted");
      if(action === "close") return setStatus(id, "Closed");
    });

    function setStatus(id, status){
      const list = loadLeads();
      const idx = list.findIndex(x => x.id === id);
      if(idx < 0) return;
      list[idx].status = status;
      saveLeads(list);
      render();
      toast("Lead updated");
    }

    // Modal logic
    const leadModalEl = document.getElementById("leadModal");
    const leadModal = new bootstrap.Modal(leadModalEl);

    const modalLeadId = document.getElementById("modalLeadId");
    const mName = document.getElementById("mName");
    const mPhone = document.getElementById("mPhone");
    const mEmail = document.getElementById("mEmail");
    const mStatus = document.getElementById("mStatus");
    const mDate = document.getElementById("mDate");
    const mSource = document.getElementById("mSource");
    const mListingLink = document.getElementById("mListingLink");
    const mMessage = document.getElementById("mMessage");
    const mNotes = document.getElementById("mNotes");

    function openModal(id){
      const list = loadLeads();
      const lead = list.find(x => x.id === id);
      if(!lead) return;

      modalLeadId.value = lead.id;
      mName.textContent = lead.name || "â€”";
      mPhone.textContent = lead.phone || "â€”";
      mEmail.textContent = lead.email || "â€”";
      mStatus.textContent = lead.status || "â€”";
      mDate.textContent = lead.date || "â€”";
      mSource.textContent = lead.source || "â€”";

      mListingLink.textContent = "Listing #" + (lead.listingId ?? "â€”");
      mListingLink.href = "admin-listing-detail.html?id=" + encodeURIComponent(lead.listingId ?? "");

      mMessage.textContent = lead.message || "â€”";
      mNotes.value = lead.notes || "";

      leadModal.show();
    }

    document.getElementById("saveNotesBtn").addEventListener("click", () => {
      const id = modalLeadId.value;
      const list = loadLeads();
      const idx = list.findIndex(x => x.id === id);
      if(idx < 0) return;
      list[idx].notes = mNotes.value || "";
      saveLeads(list);
      toast("Notes saved");
    });

    document.getElementById("markContactedBtn").addEventListener("click", () => {
      const id = modalLeadId.value;
      setStatus(id, "Contacted");
    });

    document.getElementById("closeLeadBtn").addEventListener("click", () => {
      const id = modalLeadId.value;
      setStatus(id, "Closed");
    });

    // Filters
    document.getElementById("filterForm").addEventListener("submit", (e) => {
      e.preventDefault();
      render();
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      statusFilter.value = "";
      dateFilter.value = "";
      searchFilter.value = "";
      render();
      toast("Filters reset");
    });

    // Buttons
    document.getElementById("seedBtn").addEventListener("click", seedDemo);
    document.getElementById("refreshBtn").addEventListener("click", () => { render(); toast("Refreshed"); });

    document.getElementById("clearBtn").addEventListener("click", () => {
      const ok = confirm("Clear demo leads from this browser?");
      if(!ok) return;
      localStorage.removeItem(LS_LEADS);
      render();
      toast("Cleared");
    });

    // Export CSV
    document.getElementById("exportBtn").addEventListener("click", () => {
      const all = loadLeads();
      const list = applyFilters(all);
      if(list.length === 0){ toast("No leads to export"); return; }

      const headers = ["name","phone","email","listingId","status","date","source","message","notes"];
      const rows = [headers.join(",")];

      list.forEach(l => {
        const vals = headers.map(h => {
          const v = (l[h] ?? "");
          const s = String(v).replaceAll('"','""');
          return `"${s}"`;
        });
        rows.push(vals.join(","));
      });

      const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "admin-leads.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("CSV exported");
    });

    // Init
    render();
  </script>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/http.js"></script>
  <script src="assets/js/admin.js"></script>
  <script>Admin.wireComingSoon(); Admin.loadBadges(); Admin.loadPendingCounts();</script>
</body>
</html>

