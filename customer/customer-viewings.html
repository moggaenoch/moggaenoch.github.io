<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Viewing Requests | Juba Homez</title>
  <meta name="description" content="Request, reschedule, or cancel property viewings on Juba Homez." />

  <link rel="icon" type="image/x-icon" href="../../assets/pictures logo/JUBA HOMEZ LOGO.png" />

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

  <style>
    :root { --jh-bg:#f8fafc; --jh-card:#fff; }
    body { background: var(--jh-bg); }

    .page-header{
      background: linear-gradient(180deg, rgba(25,135,84,.10), rgba(25,135,84,0));
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .card-soft{
      background: var(--jh-card);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,.04);
    }
    .small-muted{ color:#6c757d; }
    .mono{ font-variant-numeric: tabular-nums; }

    .list-compact .list-group-item { padding: .8rem 1rem; }
    .badge-soft {
      background: rgba(13,110,253,.10);
      color: #0d6efd;
      border: 1px solid rgba(13,110,253,.20);
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="../../index.html">
        <i class="bi bi-house-door me-2"></i>Juba Homez
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav"
              aria-controls="topNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="topNav">
        <ul class="navbar-nav ms-auto gap-1">
          <li class="nav-item"><a class="nav-link" href="../../index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="./customer-dashboard.html">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="./customer-viewings.html">Viewing Requests</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <header class="page-header py-4">
    <div class="container">
      <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
        <div>
          <h1 class="h3 mb-1">Viewing Requests</h1>
          <p class="mb-0 small-muted">Request a viewing for a property, then manage scheduled appointments.</p>
        </div>

        <div class="d-flex gap-2 align-items-center flex-wrap">
          <button id="btnOpenRequest" class="btn btn-success" type="button">
            <i class="bi bi-calendar-plus me-1"></i>Request Viewing
          </button>

          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input id="q" type="search" class="form-control" placeholder="Search (property id, status...)" autocomplete="off" />
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="py-4">
    <div class="container">
      <!-- Alerts -->
      <div id="pageError" class="alert alert-danger d-none" role="alert">
        <div class="fw-semibold mb-1">Couldn’t load.</div>
        <div id="pageErrorMsg" class="small mb-0">Please refresh and try again.</div>
      </div>

      <!-- Requests -->
      <section class="card-soft p-3 p-md-4 mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
          <div>
            <h2 class="h5 mb-1">My Viewing Requests</h2>
            <div class="small-muted">Requests you sent to brokers/owners.</div>
          </div>
          <button id="btnReload" class="btn btn-outline-secondary btn-sm" type="button">
            <i class="bi bi-arrow-clockwise me-1"></i>Reload
          </button>
        </div>

        <div id="requestsLoading" class="alert alert-info d-flex align-items-center gap-2" role="alert">
          <div class="spinner-border spinner-border-sm" aria-hidden="true"></div>
          <div>Loading requests…</div>
        </div>

        <ul id="requestsList" class="list-group list-compact"></ul>
      </section>

      <!-- Scheduled viewings -->
      <section class="card-soft p-3 p-md-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
          <div>
            <h2 class="h5 mb-1">My Scheduled Viewings</h2>
            <div class="small-muted">Appointments that were scheduled from your requests.</div>
          </div>
          <div class="d-flex gap-2">
            <select id="statusFilter" class="form-select form-select-sm" style="max-width: 220px;">
              <option value="">All statuses</option>
              <option value="upcoming">Upcoming</option>
              <option value="cancelled">Cancelled</option>
              <option value="completed">Completed</option>
            </select>
          </div>
        </div>

        <div id="viewingsLoading" class="alert alert-info d-flex align-items-center gap-2" role="alert">
          <div class="spinner-border spinner-border-sm" aria-hidden="true"></div>
          <div>Loading viewings…</div>
        </div>

        <ul id="viewingsList" class="list-group list-compact"></ul>
      </section>
    </div>
  </main>

  <!-- Request Viewing Modal -->
  <div class="modal fade" id="requestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form class="modal-content" id="requestForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>Request a Viewing</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-5">
              <label class="form-label">Property ID</label>
              <input id="propertyId" class="form-control" placeholder="e.g. 101" required />

              <label class="form-label mt-3">Send request to</label>
              <select id="recipientRole" class="form-select">
                <option value="broker" selected>Broker</option>
                <option value="owner">Owner</option>
              </select>
              <div class="form-text">
                Backend will validate the selection (broker/owner must belong to this property).
              </div>

              <label class="form-label mt-3">Message (optional)</label>
              <textarea id="message" class="form-control" rows="3" placeholder="Any notes, landmarks, preferred contact time..."></textarea>
            </div>

            <div class="col-12 col-md-7">
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label">Your name</label>
                  <input id="name" class="form-control" required />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Phone</label>
                  <input id="phone" class="form-control" required placeholder="+211..." />
                </div>
                <div class="col-12">
                  <label class="form-label">Email</label>
                  <input id="email" type="email" class="form-control" required />
                </div>

                <div class="col-12">
                  <label class="form-label">Preferred dates/times</label>
                  <div id="preferredDatesWrap" class="d-flex flex-column gap-2"></div>
                  <button class="btn btn-sm btn-outline-primary mt-2" type="button" id="btnAddDate">
                    <i class="bi bi-plus-lg me-1"></i>Add another date
                  </button>
                  <div class="form-text">Provide 1–3 options so the broker/owner can pick a slot.</div>
                </div>

                <div class="col-12">
                  <div class="alert alert-info mb-0">
                    <div class="fw-semibold">Next step</div>
                    <div class="small">
                      The broker/owner reviews your request and schedules the appointment.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- row -->
        </div>

        <div class="modal-footer">
          <div class="me-auto small-muted" id="reqStatus"></div>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-success" id="btnSubmitRequest">
            <span class="spinner-border spinner-border-sm d-none" id="reqSpinner" aria-hidden="true"></span>
            <span id="reqBtnText"><i class="bi bi-send me-1"></i>Submit Request</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Reschedule Modal -->
  <div class="modal fade" id="rescheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" id="rescheduleForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-calendar2-week me-2"></i>Reschedule Viewing</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="rescheduleId" />
          <div class="mb-2 small-muted" id="rescheduleMeta"></div>

          <label class="form-label">New date & time</label>
          <input id="newScheduledAt" type="datetime-local" class="form-control" required />

          <label class="form-label mt-3">Reason</label>
          <input id="rescheduleReason" class="form-control" required placeholder="e.g., I’m not available at that time." />
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" id="btnSubmitReschedule">
            <span class="spinner-border spinner-border-sm d-none" id="resSpinner" aria-hidden="true"></span>
            Submit
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cancel Modal -->
  <div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" id="cancelForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-x-circle me-2"></i>Cancel Viewing</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="cancelId" />
          <div class="mb-2 small-muted" id="cancelMeta"></div>

          <label class="form-label">Reason</label>
          <input id="cancelReason" class="form-control" required placeholder="e.g., I’m no longer interested." />
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-danger" id="btnSubmitCancel">
            <span class="spinner-border spinner-border-sm d-none" id="canSpinner" aria-hidden="true"></span>
            Cancel viewing
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="toast" class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Done.</div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../../assets/js/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // -------- Guard (customer must be logged in) ----------
    (function guard() {
      const tokenKey = window.APP_CONFIG?.STORAGE_KEYS?.ACCESS_TOKEN || "jh_access_token";
      const userKey  = window.APP_CONFIG?.STORAGE_KEYS?.USER || "jh_user";

      const token = localStorage.getItem(tokenKey);
      let user = {};
      try { user = JSON.parse(localStorage.getItem(userKey) || "{}"); } catch { user = {}; }

      const role = String(user?.role || "").toLowerCase();
      if (!token) {
        window.location.href = "../../auth/login.html";
        return;
      }
      if (role && role !== "customer") {
        window.location.href = "../../index.html";
      }
    })();

    // -------- Helpers ----------
    const $ = (sel, root = document) => root.querySelector(sel);

    function toast(msg) {
      $("#toastMsg").textContent = msg;
      new bootstrap.Toast($("#toast"), { delay: 3500 }).show();
    }

    function apiUrl(path = "") {
      return window.APP_CONFIG.utils.apiUrl(path);
    }

    async function fetchJson(path, opts = {}) {
      const url = path.startsWith("http") ? path : apiUrl(path);
      const headers = window.APP_CONFIG.utils.getAuthHeaders(opts.headers || {});
      const res = await fetch(url, {
        method: opts.method || "GET",
        headers,
        credentials: "omit",
        body: opts.body ?? undefined
      });

      const ct = res.headers.get("content-type") || "";
      const isJson = ct.includes("application/json");
      let data = null;
      try { data = isJson ? await res.json() : await res.text(); } catch { data = null; }

      if (!res.ok) {
        const msg =
          (data && typeof data === "object" && (data.error?.message || data.message)) ||
          (typeof data === "string" && data) ||
          `HTTP ${res.status}`;
        const err = new Error(msg);
        err.status = res.status;
        err.data = data;
        throw err;
      }

      return data;
    }

    function setError(msg) {
      $("#pageErrorMsg").textContent = String(msg || "Unknown error");
      $("#pageError").classList.remove("d-none");
    }

    function clearError() {
      $("#pageError").classList.add("d-none");
    }

    function fmtDT(v) {
      const d = new Date(v);
      return Number.isNaN(d.getTime()) ? String(v || "") : d.toLocaleString();
    }

    function statusBadge(status) {
      const s = String(status || "").toLowerCase();
      if (s === "pending")   return `<span class="badge text-bg-warning text-dark">Pending</span>`;
      if (s === "accepted")  return `<span class="badge text-bg-success">Accepted</span>`;
      if (s === "rejected")  return `<span class="badge text-bg-danger">Rejected</span>`;
      if (s === "upcoming")  return `<span class="badge text-bg-primary">Upcoming</span>`;
      if (s === "cancelled") return `<span class="badge text-bg-danger">Cancelled</span>`;
      if (s === "completed") return `<span class="badge text-bg-secondary">Completed</span>`;
      return `<span class="badge badge-soft">${status || "unknown"}</span>`;
    }

    // -------- API ----------
    const API = {
      // Requires your updated routes/controller to allow customers
      getMyRequests: async () => {
        const data = await fetchJson("/viewings/requests");
        return data?.requests || data?.items || (Array.isArray(data) ? data : []);
      },
      getMyViewings: async (status = "") => {
        const qs = status ? `?status=${encodeURIComponent(status)}` : "";
        const data = await fetchJson(`/viewings${qs}`);
        return data?.viewings || data?.items || (Array.isArray(data) ? data : []);
      },
      requestViewing: async (propertyId, payload) => {
        return await fetchJson(`/viewings/properties/${encodeURIComponent(propertyId)}/requests`, {
          method: "POST",
          body: JSON.stringify(payload)
        });
      },
      reschedule: async (id, payload) => {
        return await fetchJson(`/viewings/${encodeURIComponent(id)}/reschedule`, {
          method: "PATCH",
          body: JSON.stringify(payload)
        });
      },
      cancel: async (id, payload) => {
        return await fetchJson(`/viewings/${encodeURIComponent(id)}/cancel`, {
          method: "PATCH",
          body: JSON.stringify(payload)
        });
      }
    };

    // -------- UI state ----------
    let requests = [];
    let viewings = [];

    function applySearch() {
      const q = String($("#q").value || "").trim().toLowerCase();
      const rf = requests.filter(r => JSON.stringify(r).toLowerCase().includes(q));
      const vf = viewings.filter(v => JSON.stringify(v).toLowerCase().includes(q));
      renderRequests(rf);
      renderViewings(vf);
    }

    function renderRequests(list) {
      const el = $("#requestsList");
      if (!list.length) {
        el.innerHTML = `<li class="list-group-item text-muted">No requests yet.</li>`;
        return;
      }

      el.innerHTML = list.map(r => `
        <li class="list-group-item">
          <div class="d-flex justify-content-between gap-3">
            <div>
              <div class="fw-semibold">Request #${r.id} • Property #${r.property_id}</div>
              <div class="small text-muted">From: ${r.requester_name || "—"} • ${r.requester_email || ""} • ${r.requester_phone || ""}</div>
              <div class="small text-muted">Created: ${fmtDT(r.created_at)}</div>
            </div>
            <div class="text-end">
              ${statusBadge(r.status)}
            </div>
          </div>
        </li>
      `).join("");
    }

    function renderViewings(list) {
      const el = $("#viewingsList");
      if (!list.length) {
        el.innerHTML = `<li class="list-group-item text-muted">No scheduled viewings found.</li>`;
        return;
      }

      el.innerHTML = list.map(v => {
        const canEdit = String(v.status).toLowerCase() === "upcoming";
        return `
          <li class="list-group-item">
            <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
              <div>
                <div class="fw-semibold">Viewing #${v.id} • Property #${v.property_id}</div>
                <div class="small text-muted">Scheduled: <span class="fw-semibold">${fmtDT(v.scheduled_at)}</span></div>
                ${v.cancel_reason ? `<div class="small text-muted">Reason: ${v.cancel_reason}</div>` : ""}
                <div class="mt-2">${statusBadge(v.status)}</div>
              </div>

              <div class="d-flex gap-2 align-items-start">
                <button class="btn btn-outline-primary btn-sm" type="button"
                        data-action="reschedule" data-id="${v.id}" ${canEdit ? "" : "disabled"}>
                  <i class="bi bi-calendar2-week me-1"></i>Reschedule
                </button>
                <button class="btn btn-outline-danger btn-sm" type="button"
                        data-action="cancel" data-id="${v.id}" ${canEdit ? "" : "disabled"}>
                  <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
              </div>
            </div>
          </li>
        `;
      }).join("");
    }

    // -------- Modals ----------
    let requestModal, rescheduleModal, cancelModal;

    function setBusy(btnId, spinnerId, busy, textWhenNotBusy) {
      $(spinnerId).classList.toggle("d-none", !busy);
      $(btnId).disabled = !!busy;
      if (!busy && textWhenNotBusy) $(btnId).innerHTML = textWhenNotBusy;
    }

    function addPreferredDate(value="") {
      const wrap = $("#preferredDatesWrap");
      const row = document.createElement("div");
      row.className = "d-flex gap-2 align-items-center";
      row.innerHTML = `
        <input type="datetime-local" class="form-control preferred-date" ${wrap.children.length === 0 ? "required" : ""} />
        <button class="btn btn-outline-danger" type="button" title="Remove"><i class="bi bi-trash"></i></button>
      `;
      row.querySelector("input").value = value;
      row.querySelector("button").onclick = () => row.remove();
      wrap.appendChild(row);
    }

    function prefillRequestForm() {
      // Fill from stored user if available
      const userKey = window.APP_CONFIG?.STORAGE_KEYS?.USER || "jh_user";
      let user = {};
      try { user = JSON.parse(localStorage.getItem(userKey) || "{}"); } catch { user = {}; }

      $("#name").value  = user?.name || user?.full_name || "";
      $("#email").value = user?.email || "";
      $("#phone").value = user?.phone || "";

      // from URL ?propertyId=123&openRequest=1
      const params = new URLSearchParams(location.search);
      const pid = params.get("propertyId");
      const open = params.get("openRequest");
      if (pid) $("#propertyId").value = pid;
      if (open === "1") requestModal.show();
    }

    // -------- Loaders ----------
    async function loadAll() {
      clearError();

      $("#requestsLoading").classList.remove("d-none");
      $("#viewingsLoading").classList.remove("d-none");

      try {
        requests = await API.getMyRequests();
      } catch (e) {
        // If backend not updated yet, show readable message
        setError(e.message || e);
        requests = [];
      } finally {
        $("#requestsLoading").classList.add("d-none");
      }

      try {
        const status = $("#statusFilter").value;
        viewings = await API.getMyViewings(status);
      } catch (e) {
        setError(e.message || e);
        viewings = [];
      } finally {
        $("#viewingsLoading").classList.add("d-none");
      }

      applySearch();
    }

    // -------- Init ----------
    document.addEventListener("DOMContentLoaded", () => {
      requestModal = new bootstrap.Modal($("#requestModal"));
      rescheduleModal = new bootstrap.Modal($("#rescheduleModal"));
      cancelModal = new bootstrap.Modal($("#cancelModal"));

      // Preferred dates default
      addPreferredDate();
      $("#btnAddDate").addEventListener("click", () => {
        if ($("#preferredDatesWrap").children.length >= 3) return toast("Max 3 preferred dates.");
        addPreferredDate();
      });

      // Open request
      $("#btnOpenRequest").addEventListener("click", () => requestModal.show());

      // Reload
      $("#btnReload").addEventListener("click", loadAll);

      // Filters/search
      $("#q").addEventListener("input", applySearch);
      $("#statusFilter").addEventListener("change", loadAll);

      // Submit request
      $("#requestForm").addEventListener("submit", async (ev) => {
        ev.preventDefault();
        clearError();

        const propertyId = $("#propertyId").value.trim();
        const payload = {
          name: $("#name").value.trim(),
          email: $("#email").value.trim(),
          phone: $("#phone").value.trim(),
          preferredDates: Array.from(document.querySelectorAll(".preferred-date")).map(i => i.value).filter(Boolean),
          message: ($("#message").value || "").trim() || undefined,
          recipientRole: $("#recipientRole").value // "broker" or "owner"
        };

        $("#reqStatus").textContent = "Submitting…";
        $("#reqSpinner").classList.remove("d-none");
        $("#btnSubmitRequest").disabled = true;

        try {
          await API.requestViewing(propertyId, payload);
          toast("Viewing request sent!");
          requestModal.hide();

          // Reset form but keep one preferred date input
          ev.target.reset();
          $("#preferredDatesWrap").innerHTML = "";
          addPreferredDate();
          $("#reqStatus").textContent = "";

          await loadAll();
        } catch (e) {
          $("#reqStatus").textContent = "";
          setError(e.message || e);
        } finally {
          $("#reqSpinner").classList.add("d-none");
          $("#btnSubmitRequest").disabled = false;
        }
      });

      // Viewings actions
      $("#viewingsList").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;

        const id = btn.getAttribute("data-id");
        const action = btn.getAttribute("data-action");
        const v = viewings.find(x => String(x.id) === String(id));
        if (!v) return;

        if (action === "reschedule") {
          $("#rescheduleId").value = id;
          $("#rescheduleMeta").textContent = `Viewing #${id} • Current: ${fmtDT(v.scheduled_at)}`;

          // set min to now + 30 minutes
          const min = new Date(Date.now() + 30 * 60 * 1000);
          const pad = n => String(n).padStart(2, "0");
          const toLocal = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
          $("#newScheduledAt").min = toLocal(min);
          $("#newScheduledAt").value = toLocal(new Date(v.scheduled_at));

          $("#rescheduleReason").value = "";
          rescheduleModal.show();
        }

        if (action === "cancel") {
          $("#cancelId").value = id;
          $("#cancelMeta").textContent = `Viewing #${id} • Scheduled: ${fmtDT(v.scheduled_at)}`;
          $("#cancelReason").value = "";
          cancelModal.show();
        }
      });

      // Submit reschedule
      $("#rescheduleForm").addEventListener("submit", async (ev) => {
        ev.preventDefault();
        clearError();

        const id = $("#rescheduleId").value;
        const payload = {
          newScheduledAt: $("#newScheduledAt").value,
          reason: $("#rescheduleReason").value.trim()
        };

        $("#resSpinner").classList.remove("d-none");
        $("#btnSubmitReschedule").disabled = true;

        try {
          await API.reschedule(id, payload);
          toast("Reschedule saved.");
          rescheduleModal.hide();
          await loadAll();
        } catch (e) {
          setError(e.message || e);
        } finally {
          $("#resSpinner").classList.add("d-none");
          $("#btnSubmitReschedule").disabled = false;
        }
      });

      // Submit cancel
      $("#cancelForm").addEventListener("submit", async (ev) => {
        ev.preventDefault();
        clearError();

        const id = $("#cancelId").value;
        const payload = { reason: $("#cancelReason").value.trim() };

        $("#canSpinner").classList.remove("d-none");
        $("#btnSubmitCancel").disabled = true;

        try {
          await API.cancel(id, payload);
          toast("Viewing cancelled.");
          cancelModal.hide();
          await loadAll();
        } catch (e) {
          setError(e.message || e);
        } finally {
          $("#canSpinner").classList.add("d-none");
          $("#btnSubmitCancel").disabled = false;
        }
      });

      // Prefill and load
      prefillRequestForm();
      loadAll();
    });
  </script>
</body>
</html>
