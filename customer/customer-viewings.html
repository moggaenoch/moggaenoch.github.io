<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>My Viewings | Juba Homez</title>
  <meta name="description" content="Manage your property viewing requests and upcoming viewing schedules on Juba Homez." />

  <link rel="icon" type="image/x-icon" href="../../assets/pictures logo/JUBA HOMEZ LOGO.png" />

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

  <style>
    :root { --jh-bg:#f8fafc; --jh-card:#fff; }
    body { background: var(--jh-bg); }
    .page-header{
      background: linear-gradient(180deg, rgba(25,135,84,.10), rgba(25,135,84,0));
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .view-card{
      background: var(--jh-card);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,.04);
      height: 100%;
    }
    .view-img{ width:100%; height:170px; object-fit:cover; background:#e9ecef; }
    .small-muted{ color:#6c757d; }
    .mono{ font-variant-numeric: tabular-nums; }
    .pill{
      background: rgba(13,110,253,.10);
      color: #0d6efd;
      border: 1px solid rgba(13,110,253,.20);
      border-radius: 999px;
      padding: .2rem .55rem;
      font-size: .8rem;
      display: inline-flex;
      gap: .35rem;
      align-items: center;
      white-space: nowrap;
    }
    .actions .btn { white-space: nowrap; }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="../../index.html">
        <i class="bi bi-house-door me-2"></i>Juba Homez
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav"
              aria-controls="topNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="topNav">
        <ul class="navbar-nav ms-auto gap-1">
          <li class="nav-item"><a class="nav-link" href="../../index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="./customer-dashboard.html">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="./customer-viewings.html">Viewings</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <header class="page-header py-4">
    <div class="container">
      <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
        <div>
          <h1 class="h3 mb-1">My Viewings</h1>
          <p class="mb-0 small-muted">Request a viewing, then manage reschedules/cancellations when it’s scheduled.</p>
        </div>

        <div class="d-flex gap-2 align-items-center flex-wrap">
          <button id="btnOpenRequest" class="btn btn-success">
            <i class="bi bi-calendar-plus me-1"></i>Request Viewing
          </button>

          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input id="viewSearch" type="search" class="form-control" placeholder="Search by location / property / status" autocomplete="off" />
          </div>

          <select id="statusFilter" class="form-select" style="max-width: 220px;">
            <option value="">All statuses</option>
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="cancelled">Cancelled</option>
            <option value="completed">Completed</option>
          </select>

          <select id="timeFilter" class="form-select" style="max-width: 220px;">
            <option value="upcoming">Upcoming</option>
            <option value="all">All</option>
            <option value="past">Past</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main class="py-4">
    <div class="container">
      <!-- States -->
      <div id="viewingsLoading" class="alert alert-info d-flex align-items-center gap-2" role="alert">
        <div class="spinner-border spinner-border-sm" aria-hidden="true"></div>
        <div>Loading…</div>
      </div>

      <div id="viewingsError" class="alert alert-danger d-none" role="alert">
        <div class="fw-semibold mb-1">Couldn’t load.</div>
        <div id="viewingsErrorMsg" class="small mb-0">Please refresh and try again.</div>
      </div>

      <div id="viewingsEmpty" class="border rounded-4 bg-white p-4 d-none">
        <div class="d-flex align-items-start gap-3">
          <div class="fs-3 text-success"><i class="bi bi-calendar-check"></i></div>
          <div>
            <div class="fw-semibold mb-1">Nothing to show yet</div>
            <div class="small-muted mb-3">Request a viewing and it will appear here (or in your requests list).</div>
            <button class="btn btn-success" id="btnOpenRequest2" type="button">
              <i class="bi bi-calendar-plus me-1"></i>Request Viewing
            </button>
          </div>
        </div>
      </div>

      <!-- List (your scheduled viewings – might be broker/owner only depending on backend roles) -->
      <ul id="viewingsList" class="row g-3 list-unstyled m-0"></ul>

      <!-- Customer Requests (stored locally after submit; replace with a real endpoint later if you add it) -->
      <div class="mt-4">
        <h2 class="h5 mb-2">My Viewing Requests</h2>
        <div class="small-muted mb-2">After you request, the broker/owner will schedule it.</div>
        <ul id="requestsList" class="list-group"></ul>
      </div>
    </div>
  </main>

  <!-- Request Viewing Modal -->
  <div class="modal fade" id="requestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form class="modal-content" id="requestForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>Request a Viewing</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-5">
              <label class="form-label">Property ID</label>
              <div class="input-group">
                <input id="reqPropertyId" class="form-control" placeholder="e.g. 12" required />
                <button class="btn btn-outline-secondary" type="button" id="btnFetchProperty">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div class="form-text">Tip: open this page with <span class="mono">?propertyId=12</span> to auto-fill.</div>

              <div class="border rounded-3 p-3 mt-3 bg-light">
                <div class="fw-semibold" id="propTitle">Property not loaded</div>
                <div class="small-muted" id="propMeta">Enter a Property ID and click search.</div>
              </div>

              <label class="form-label mt-3">Send request to</label>
              <select id="reqRecipient" class="form-select" disabled>
                <option value="">Load property first</option>
              </select>
              <div class="form-text">
                If the property has a broker, the backend currently routes to broker by default.
                (See optional backend patch below to enforce selection.)
              </div>

              <input type="hidden" id="reqRecipientUserId" />
              <input type="hidden" id="reqRecipientRole" />
            </div>

            <div class="col-12 col-md-7">
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label">Your name</label>
                  <input id="reqName" class="form-control" required />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Phone</label>
                  <input id="reqPhone" class="form-control" required placeholder="+211..." />
                </div>
                <div class="col-12">
                  <label class="form-label">Email</label>
                  <input id="reqEmail" type="email" class="form-control" required />
                </div>

                <div class="col-12">
                  <label class="form-label">Preferred dates/times</label>
                  <div id="preferredDatesWrap" class="d-flex flex-column gap-2"></div>
                  <button class="btn btn-sm btn-outline-primary mt-2" type="button" id="btnAddDate">
                    <i class="bi bi-plus-lg me-1"></i>Add another date
                  </button>
                  <div class="form-text">Provide 1–3 options so the broker/owner can pick a slot.</div>
                </div>

                <div class="col-12">
                  <label class="form-label">Message (optional)</label>
                  <textarea id="reqMessage" class="form-control" rows="3" placeholder="Any notes, landmarks, preferred contact time..."></textarea>
                </div>

                <div class="col-12">
                  <div class="alert alert-info mb-0">
                    <div class="fw-semibold">What happens next?</div>
                    <div class="small">
                      Your request is sent to the selected broker/owner, then they create the scheduled viewing.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- row -->
        </div>

        <div class="modal-footer">
          <div class="me-auto small-muted" id="reqStatus"></div>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-success" id="btnSubmitRequest">
            <span class="spinner-border spinner-border-sm d-none" id="reqSpinner" aria-hidden="true"></span>
            <span id="reqBtnText"><i class="bi bi-send me-1"></i>Submit Request</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="toast" class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Done.</div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Project scripts -->
  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/js/http.js"></script>
  <script src="../../assets/js/nav-areas.js"></script>
  <!-- keep this if you have it; page will still work if it 404s -->
  <script src="../../assets/js/customer.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== Utilities =====
    const $ = (sel, root = document) => root.querySelector(sel);
    const LS_REQ_KEY = "jh_viewing_requests";

    function toast(msg){
      $("#toastMsg").textContent = msg;
      new bootstrap.Toast($("#toast"), { delay: 3500 }).show();
    }

    function showState({loading=false, error="", empty=false} = {}){
      $("#viewingsLoading").classList.toggle("d-none", !loading);

      const errBox = $("#viewingsError");
      if (error){
        $("#viewingsErrorMsg").textContent = error;
        errBox.classList.remove("d-none");
      } else errBox.classList.add("d-none");

      $("#viewingsEmpty").classList.toggle("d-none", !empty);
    }

    function apiUrl(path){
      if (!window.APP_CONFIG?.utils?.apiUrl) {
        throw new Error("APP_CONFIG.utils.apiUrl is missing. Check assets/js/config.js");
      }
      return window.APP_CONFIG.utils.apiUrl(path);
    }

    async function fetchJson(path, { method="GET", body=null } = {}){
      const url = path.startsWith("http") ? path : apiUrl(path);
      const headers = window.APP_CONFIG?.utils?.getAuthHeaders?.({}) || { "Content-Type": "application/json" };

      const res = await fetch(url, {
        method,
        headers,
        // IMPORTANT: backend has credentials:false, so do NOT use credentials:"include"
        body: body ? JSON.stringify(body) : null
      });

      const ct = res.headers.get("content-type") || "";
      const isJson = ct.includes("application/json");
      const data = isJson ? await res.json().catch(() => ({})) : await res.text().catch(() => "");

      if (!res.ok){
        const msg = (data && (data.message || data.error)) || (typeof data === "string" && data) || `HTTP ${res.status}`;
        const err = new Error(msg);
        err.status = res.status;
        throw err;
      }
      return data;
    }

    function getUserFromStorage(){
      try {
        const raw = localStorage.getItem(window.APP_CONFIG?.STORAGE_KEYS?.USER || "jh_user");
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    function setBusy(busy){
      $("#reqSpinner").classList.toggle("d-none", !busy);
      $("#reqBtnText").innerHTML = busy ? "Submitting…" : `<i class="bi bi-send me-1"></i>Submit Request`;
      $("#btnSubmitRequest").disabled = !!busy;
    }

    function readRequests(){
      try {
        const raw = localStorage.getItem(LS_REQ_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    function writeRequests(arr){
      localStorage.setItem(LS_REQ_KEY, JSON.stringify(arr));
    }

    function renderRequests(){
      const list = $("#requestsList");
      const reqs = readRequests();
      if (!reqs.length){
        list.innerHTML = `<li class="list-group-item text-muted">No requests yet.</li>`;
        return;
      }
      list.innerHTML = reqs.slice().reverse().map(r => `
        <li class="list-group-item">
          <div class="d-flex justify-content-between gap-3">
            <div>
              <div class="fw-semibold">Property #${r.propertyId} — ${r.propertyTitle || "Viewing request"}</div>
              <div class="small text-muted">
                To: ${r.recipientLabel || "Broker/Owner"} • Sent: ${new Date(r.createdAt).toLocaleString()}
              </div>
              <div class="small mt-1"><span class="text-muted">Preferred:</span> ${(r.preferredDates || []).join(" | ") || "—"}</div>
            </div>
            <span class="badge text-bg-warning text-dark align-self-start">Pending</span>
          </div>
        </li>
      `).join("");
    }

    // ===== Property + Recipient lookup =====
    async function getProperty(propertyId){
      const data = await fetchJson(`/properties/${encodeURIComponent(propertyId)}`);
      return data?.property || data?.data?.property || null;
    }

    async function getPublicProfile(userId){
      const data = await fetchJson(`/users/${encodeURIComponent(userId)}/public`);
      return data?.profile || null;
    }

    async function loadPropertyIntoModal(propertyId){
      $("#reqStatus").textContent = "";
      $("#propTitle").textContent = "Loading property…";
      $("#propMeta").textContent = "";
      $("#reqRecipient").innerHTML = `<option value="">Loading…</option>`;
      $("#reqRecipient").disabled = true;

      const p = await getProperty(propertyId);
      if (!p) throw new Error("Property not found");

      $("#propTitle").textContent = p.title || `Property #${p.id}`;
      $("#propMeta").textContent = `${p.location || ""}${p.area ? " • " + p.area : ""}`.trim() || "—";

      const brokerId = p.broker_id || p.brokerId || null;
      const ownerId  = p.owner_id  || p.ownerId  || null;

      // Fetch names (public profiles)
      const options = [];
      if (brokerId){
        const prof = await getPublicProfile(brokerId).catch(() => null);
        options.push({
          role: "broker",
          id: brokerId,
          label: prof?.name ? `Broker: ${prof.name}` : `Broker (User #${brokerId})`
        });
      }
      if (ownerId){
        const prof = await getPublicProfile(ownerId).catch(() => null);
        options.push({
          role: "owner",
          id: ownerId,
          label: prof?.name ? `Owner: ${prof.name}` : `Owner (User #${ownerId})`
        });
      }

      if (!options.length){
        $("#reqRecipient").innerHTML = `<option value="">No broker/owner assigned</option>`;
        $("#reqRecipient").disabled = true;
        $("#reqRecipientUserId").value = "";
        $("#reqRecipientRole").value = "";
        return;
      }

      // Default selection: broker if exists, else owner (matches backend default)
      $("#reqRecipient").innerHTML = options.map(o =>
        `<option value="${o.role}" data-user-id="${o.id}">${o.label}</option>`
      ).join("");
      $("#reqRecipient").disabled = false;

      // Set hidden recipient fields based on selection
      const setHidden = () => {
        const sel = $("#reqRecipient");
        const opt = sel.options[sel.selectedIndex];
        $("#reqRecipientRole").value = sel.value || "";
        $("#reqRecipientUserId").value = opt?.getAttribute("data-user-id") || "";
      };
      $("#reqRecipient").onchange = setHidden;
      setHidden();

      // Store property details on the form for save-to-local
      $("#requestForm").dataset.propertyTitle = p.title || "";
    }

    // ===== Preferred dates UI =====
    function addPreferredDate(value=""){
      const wrap = $("#preferredDatesWrap");
      const row = document.createElement("div");
      row.className = "d-flex gap-2 align-items-center";
      row.innerHTML = `
        <input type="datetime-local" class="form-control preferred-date" ${wrap.children.length === 0 ? "required" : ""} />
        <button class="btn btn-outline-danger" type="button" title="Remove"><i class="bi bi-trash"></i></button>
      `;
      row.querySelector("input").value = value;
      row.querySelector("button").onclick = () => row.remove();
      wrap.appendChild(row);
    }

    // ===== Create request =====
    async function createViewingRequest(propertyId, payload){
      // Backend route: POST /api/v1/viewings/properties/:propertyId/requests
      // (authOptional, so it works logged in or guest) :contentReference[oaicite:3]{index=3}
      return await fetchJson(`/viewings/properties/${encodeURIComponent(propertyId)}/requests`, {
        method: "POST",
        body: payload
      });
    }

    // ===== Page init =====
    document.addEventListener("DOMContentLoaded", async () => {
      const requestModal = new bootstrap.Modal($("#requestModal"));

      // Buttons
      $("#btnOpenRequest").onclick = () => requestModal.show();
      $("#btnOpenRequest2").onclick = () => requestModal.show();

      // preferred dates start
      addPreferredDate();
      $("#btnAddDate").onclick = () => {
        if ($("#preferredDatesWrap").children.length >= 3) {
          toast("Max 3 preferred dates.");
          return;
        }
        addPreferredDate();
      };

      // Prefill user info
      const u = getUserFromStorage();
      if (u){
        $("#reqName").value = u.name || "";
        $("#reqEmail").value = u.email || "";
        $("#reqPhone").value = u.phone || "";
      }

      // Auto-fill from query params
      const params = new URLSearchParams(window.location.search);
      const propertyIdParam = params.get("propertyId");
      const openRequest = params.get("openRequest") === "1";

      if (propertyIdParam){
        $("#reqPropertyId").value = propertyIdParam;
        // try load property in background
        loadPropertyIntoModal(propertyIdParam).catch(e => {
          $("#reqStatus").textContent = e.message || "Failed to load property.";
        });
        if (openRequest) requestModal.show();
      }

      // Fetch property button
      $("#btnFetchProperty").onclick = async () => {
        const pid = $("#reqPropertyId").value.trim();
        if (!pid) return toast("Enter Property ID first.");
        try {
          await loadPropertyIntoModal(pid);
          toast("Property loaded.");
        } catch (e) {
          toast(e.message || "Failed to load property.");
          $("#propTitle").textContent = "Property not loaded";
          $("#propMeta").textContent = "Enter a Property ID and click search.";
        }
      };

      // Submit request
      $("#requestForm").addEventListener("submit", async (ev) => {
        ev.preventDefault();

        const propertyId = $("#reqPropertyId").value.trim();
        if (!propertyId) return toast("Property ID is required.");

        const preferredDates = Array.from(document.querySelectorAll(".preferred-date"))
          .map(i => i.value)
          .filter(Boolean);

        const payload = {
          name: $("#reqName").value.trim(),
          email: $("#reqEmail").value.trim(),
          phone: $("#reqPhone").value.trim(),
          preferredDates,
          message: ($("#reqMessage").value || "").trim()
        };

        // OPTIONAL: your UI selection (broker/owner). Backend currently ignores these fields due to stripUnknown=true.
        // Add the backend patch below if you want selection to be enforced.
        const recipientRole = $("#reqRecipientRole").value;
        const recipientUserId = $("#reqRecipientUserId").value;
        if (recipientRole) payload.recipientRole = recipientRole;
        if (recipientUserId) payload.recipientUserId = Number(recipientUserId);

        setBusy(true);
        $("#reqStatus").textContent = "Submitting…";
        try {
          const res = await createViewingRequest(propertyId, payload);

          // Save a local record so customer can see their requests on this page
          const reqs = readRequests();
          reqs.push({
            propertyId: Number(propertyId),
            propertyTitle: $("#requestForm").dataset.propertyTitle || "",
            preferredDates,
            recipientLabel: $("#reqRecipient").disabled ? "Broker/Owner" : $("#reqRecipient").options[$("#reqRecipient").selectedIndex].textContent,
            createdAt: new Date().toISOString(),
            server: res
          });
          writeRequests(reqs);
          renderRequests();

          $("#reqStatus").textContent = "";
          toast("Viewing request sent!");
          ev.target.reset();

          // rebuild preferred dates to keep UI clean
          $("#preferredDatesWrap").innerHTML = "";
          addPreferredDate();

          requestModal.hide();
        } catch (e) {
          $("#reqStatus").textContent = e.message || "Request failed.";
          toast(`Request failed: ${e.message || "Unknown error"}`);
        } finally {
          setBusy(false);
        }
      });

      // Existing list behavior (may fail for customer role on current backend)
      // We'll try, but if forbidden, we just show requests list.
      showState({ loading: true });
      try {
        // This endpoint is restricted in your backend (broker/owner/etc). :contentReference[oaicite:4]{index=4}
        const data = await fetchJson("/viewings");
        const viewings = Array.isArray(data) ? data : (data.viewings || data.items || []);
        $("#viewingsList").innerHTML = viewings.length
          ? viewings.map(v => `
              <li class="col-12 col-md-6 col-lg-4">
                <div class="view-card p-3">
                  <div class="fw-semibold">Viewing #${v.id}</div>
                  <div class="small text-muted">Property #${v.property_id}</div>
                  <div class="mt-2"><span class="text-muted">When:</span> <span class="fw-semibold">${new Date(v.scheduled_at).toLocaleString()}</span></div>
                  <div><span class="text-muted">Status:</span> <span class="fw-semibold">${v.status}</span></div>
                </div>
              </li>
            `).join("")
          : "";

        showState({ loading: false, empty: !viewings.length });
      } catch (e) {
        // If customer gets 403, we don’t treat it as fatal; they can still request viewings.
        showState({ loading: false, error: (e.status === 403)
          ? "Your account can request viewings. Scheduled viewings are shown after the broker/owner schedules them."
          : (e.message || "Failed to load viewings.") });
      }

      // Always show local requests list
      renderRequests();
    });
  </script>
</body>
</html>
